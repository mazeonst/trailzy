<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TG Zenly Simple</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #e5e7ee;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #3b82f6;
    }
    html,body,#map{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    #map{z-index:1}
    .ui{position:absolute;inset:0;pointer-events:none}
    .sidebar{
      position:absolute;left:12px;top:12px;bottom:12px;width:120px;
      display:flex;flex-direction:column;gap:12px;
      background:rgba(255,255,255,.92);backdrop-filter:blur(6px);
      border-radius:18px;padding:14px 12px;box-shadow:0 14px 40px rgba(0,0,0,.16);
      pointer-events:auto;border:1px solid var(--border);
    }
    .sidebar__title{font-weight:700;font-size:14px;margin-bottom:6px}
    .friends{
      display:flex;flex-direction:column;gap:10px;overflow:auto;flex:1;
      padding-right:2px;
    }
    .friend-avatar{
      width:64px;height:64px;border-radius:18px;border:2px solid var(--border);
      object-fit:cover;cursor:pointer;transition:transform .15s, box-shadow .15s, border-color .15s;
      box-shadow:0 8px 18px rgba(0,0,0,.12);background:linear-gradient(120deg,#eef2ff,#f8fafc);
    }
    .friend-avatar:hover{transform:translateY(-3px);box-shadow:0 16px 28px rgba(0,0,0,.18);border-color:var(--accent)}
    .friend-avatar.offline{filter:grayscale(.4);opacity:.75}
    .panel{
      position:absolute;left:152px;top:12px;
      background:rgba(255,255,255,.94);backdrop-filter:blur(6px);padding:14px 16px;border-radius:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.16);
      pointer-events:auto;max-width:420px;border:1px solid var(--border);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    button,input{padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px}
    button{background:linear-gradient(120deg,#eef2ff,#e0f2fe);cursor:pointer;transition:transform .12s, box-shadow .12s;border-color:#d5d8e3}
    button:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.14)}
    button:active{transform:translateY(0);box-shadow:none}
    .muted{font-size:12px;color:var(--muted)}
    .badge{padding:4px 8px;border-radius:10px;background:#ecfdf3;color:#166534;font-size:12px;font-weight:600;border:1px solid #bbf7d0}
    .section-title{font-weight:700;margin:10px 0 4px}
    .status-line{font-size:13px;color:var(--muted);display:flex;gap:6px;align-items:center}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
    .me-chip{
      position:absolute;right:16px;top:16px;display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:16px;background:rgba(255,255,255,.94);
      box-shadow:0 10px 28px rgba(0,0,0,.18);pointer-events:auto;cursor:pointer;border:1px solid var(--border);
      transition:transform .12s, box-shadow .12s;
    }
    .me-chip:hover{transform:translateY(-2px);box-shadow:0 16px 32px rgba(0,0,0,.2)}
    .me-chip__avatar{width:48px;height:48px;border-radius:14px;object-fit:cover;border:2px solid #fff;box-shadow:0 6px 16px rgba(0,0,0,.14)}
    .me-chip__name{font-weight:700;font-size:14px}
    .me-chip__subtitle{font-size:12px;color:var(--muted)}
    .settings{position:absolute;right:16px;top:92px;min-width:260px;max-width:340px;background:rgba(255,255,255,.96);
      border-radius:16px;padding:14px 16px;box-shadow:0 16px 36px rgba(0,0,0,.2);pointer-events:auto;border:1px solid var(--border);display:none}
    .settings.active{display:block}
    .avatar-icon{border-radius:18%;border:2px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.25);object-fit:cover}
    .avatar-icon.me-icon{border-color:var(--accent)}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div class="sidebar">
      <div class="sidebar__title">–î—Ä—É–∑—å—è</div>
      <div id="friends" class="friends"></div>
    </div>

    <div class="panel">
      <div class="row">
        <button id="btnRefresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnInvite">‚ûï –ò–Ω–≤–∞–π—Ç</button>
      </div>

      <div class="row">
        <input id="code" placeholder="–ö–æ–¥ –∏–Ω–≤–∞–π—Ç–∞" />
        <button id="btnAccept">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
      </div>

      <div class="status-line"><span class="status-dot"></span><span id="status">...</span></div>
      <div class="muted">ID –∏ –ø—Ä–æ—Ñ–∏–ª—å –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram Mini App.</div>

      <div class="section-title">–õ–∞–π—Ñ—Ö–∞–∫–∏</div>
      <div class="muted">1) –í –±–æ—Ç–µ –Ω–∞–∂–º–∏ ¬´üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å LIVE-–ª–æ–∫–∞—Ü–∏—é¬ª, —á—Ç–æ–±—ã —Ç–≤–æ—è —Ç–æ—á–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–∞ –∫–∞—Ä—Ç–µ.</div>
      <div class="muted">2) –ù–∞–∂–∏–º–∞–π –∞–≤–∞—Ç–∞—Ä–∫–∏ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–µ.</div>
    </div>

    <div id="meChip" class="me-chip">
      <img id="meAvatar" class="me-chip__avatar" alt="me" />
      <div>
        <div id="meName" class="me-chip__name">...</div>
        <div id="meSubtitle" class="me-chip__subtitle">...</div>
      </div>
    </div>

    <div id="settings" class="settings">
      <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <div class="muted" style="margin-bottom:8px">–û—Ç–∫—Ä–æ–π –∫–∞–∫ Telegram Mini App, –æ—Ç–ø—Ä–∞–≤—å live-–ª–æ–∫–∞—Ü–∏—é –±–æ—Ç—É, –Ω–∞–∂–º–∏ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª. –¢–≤–æ–π –ø–∏–Ω –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–∑—å—è–º–∏.</div>
      <div class="badge">Beta ¬∑ Mini App</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    tg?.ready();

    const API_PREFIX = location.pathname.startsWith('/trailzy') ? '/trailzy' : '';
    const userId = tg?.initDataUnsafe?.user?.id;
    const username = tg?.initDataUnsafe?.user?.username;
    const name = [tg?.initDataUnsafe?.user?.first_name, tg?.initDataUnsafe?.user?.last_name]
      .filter(Boolean)
      .join(' ');

    function applyTheme(params){
      if (!params) return;
      const map = {
        bg_color: '--bg',
        secondary_bg_color: '--card',
        text_color: '--text',
        hint_color: '--muted',
        button_color: '--accent',
      };
      Object.entries(map).forEach(([key, cssVar]) => {
        if (params[key]) document.documentElement.style.setProperty(cssVar, params[key]);
      });
    }
    applyTheme(tg?.themeParams);
    tg?.onEvent?.('themeChanged', () => applyTheme(tg.themeParams));

    const statusEl = document.getElementById('status');
    const friendsEl = document.getElementById('friends');
    const meAvatarEl = document.getElementById('meAvatar');
    const meNameEl = document.getElementById('meName');
    const meSubtitleEl = document.getElementById('meSubtitle');
    const meChipEl = document.getElementById('meChip');
    const settingsEl = document.getElementById('settings');

    function setStatus(t){ statusEl.textContent = t; }

    const mapInstance = L.map('map', { zoomControl:false }).setView([52.37, 4.90], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(mapInstance);

    const markers = new Map();
    const defaultAvatar =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<?xml version="1.0"?><svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" rx="24" fill="#2563eb"/><text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="54" font-family="Arial" fill="white">üë•</text></svg>`);

    async function api(path, opts={}) {
      const r = await fetch(`${API_PREFIX}${path}`, {
        ...opts,
        headers: { 'Content-Type':'application/json', ...(opts.headers||{}) }
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function renderFriends(friends){
      friendsEl.innerHTML = '';
      if (!friends.length){
        friendsEl.innerHTML = '<div class="muted">–î—Ä—É–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
        return;
      }

      friends.forEach(f => {
        const img = document.createElement('img');
        img.className = 'friend-avatar' + (f.location ? '' : ' offline');
        img.src = f.avatar_url || defaultAvatar;
        img.alt = f.name || `Friend ${f.id}`;
        img.title = f.location ? `${f.name || '–î—Ä—É–≥'}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(f.location.updated_at*1000).toLocaleString()}` : `${f.name || '–î—Ä—É–≥'}\n–ù–µ—Ç –ª–æ–∫–∞—Ü–∏–∏`;
        img.onclick = () => focusOn(f.id);
        friendsEl.appendChild(img);
      });
    }

    function makeLabel(person, isMe=false){
      const updated = person.location ? new Date(person.location.updated_at*1000).toLocaleString() : '‚Äî';
      const headline = person.name || (isMe ? '–¢—ã' : '–î—Ä—É–≥');
      const uname = person.username ? `@${person.username}` : `ID: ${person.id}`;
      return `${headline}\n${uname}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated}${isMe ? '\n–≠—Ç–æ —Ç—ã' : ''}`;
    }

    function avatarIcon(url, isMe=false){
      return L.icon({
        iconUrl: url || defaultAvatar,
        iconSize: [54,54],
        className: isMe ? 'avatar-icon me-icon' : 'avatar-icon',
      });
    }

    function upsertMarker(person, isMe=false){
      if (!person.location) return;
      let m = markers.get(person.id);
      const label = makeLabel(person, isMe);
      if (!m){
        m = L.marker([person.location.lat, person.location.lon], { icon: avatarIcon(person.avatar_url, isMe) })
          .addTo(mapInstance)
          .bindPopup(label);
        markers.set(person.id, m);
      } else {
        m.setLatLng([person.location.lat, person.location.lon]).setPopupContent(label);
      }
    }

    function focusOn(id){
      const marker = markers.get(id);
      if (marker){
        mapInstance.setView(marker.getLatLng(), 14);
        marker.openPopup();
      }
    }

    function fitToMarkers(){
      if (!markers.size) return;
      const group = L.featureGroup(Array.from(markers.values()));
      mapInstance.fitBounds(group.getBounds().pad(0.35));
    }

    function updateMeChip(me){
      meAvatarEl.src = me.avatar_url || defaultAvatar;
      meNameEl.textContent = me.name || name || username || '–¢—ã';
      meSubtitleEl.textContent = me.username ? `@${me.username}` : `ID: ${me.id}`;
    }

    function syncMarkers(me, friends){
      const activeIds = new Set();
      if (me.location){
        upsertMarker(me, true);
        activeIds.add(me.id);
      }
      friends.forEach(f => {
        if (!f.location) return;
        upsertMarker(f, false);
        activeIds.add(f.id);
      });

      for (const [id, marker] of markers.entries()){
        if (!activeIds.has(id)){
          mapInstance.removeLayer(marker);
          markers.delete(id);
        }
      }

      if (markers.size) fitToMarkers();
    }

    async function refresh() {
      if (!userId) {
        setStatus('‚ùó –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram WebApp (–∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ)');
        return;
      }
      const [me, friends] = await Promise.all([
        api(`/api/me-full?user_id=${encodeURIComponent(userId)}`),
        api(`/api/friends-full?user_id=${encodeURIComponent(userId)}`),
      ]);

      renderFriends(friends.friends);
      updateMeChip(me);
      syncMarkers(me, friends.friends);

      const friendsWithGeo = friends.friends.filter(f => f.location).length;
      const meOnMap = Boolean(me.location);
      setStatus(`–¢—ã: ${meOnMap ? '–Ω–∞ –∫–∞—Ä—Ç–µ' : '–Ω–µ—Ç –≥–µ–æ'} ‚Ä¢ –î—Ä—É–∑—å—è –Ω–∞ –∫–∞—Ä—Ç–µ: ${friendsWithGeo}/${friends.friends.length}`);
    }

    document.getElementById('btnRefresh').onclick = () => refresh().catch(e => setStatus('–û—à–∏–±–∫–∞: ' + e.message));

    document.getElementById('btnInvite').onclick = async () => {
      try {
        const res = await api(`/api/invite?user_id=${encodeURIComponent(userId)}`, { method:'POST', body:'{}' });
        alert('–ò–Ω–≤–∞–π—Ç –∫–æ–¥:\n' + res.code);
      } catch(e) { setStatus('–û—à–∏–±–∫–∞: ' + e.message); }
    };

    document.getElementById('btnAccept').onclick = async () => {
      try {
        const code = document.getElementById('code').value.trim();
        if (!code) return;
        await api(`/api/accept?user_id=${encodeURIComponent(userId)}&code=${encodeURIComponent(code)}`, { method:'POST', body:'{}' });
        setStatus('‚úÖ –ü—Ä–∏–Ω—è—Ç–æ. –û–±–Ω–æ–≤–ª—è—é...');
        await refresh();
      } catch(e) { setStatus('–û—à–∏–±–∫–∞: ' + e.message); }
    };

    meChipEl.onclick = () => {
      settingsEl.classList.toggle('active');
      focusOn(userId);
    };

    document.addEventListener('click', (e) => {
      if (!settingsEl.classList.contains('active')) return;
      if (!settingsEl.contains(e.target) && e.target !== meChipEl && !meChipEl.contains(e.target)){
        settingsEl.classList.remove('active');
      }
    });

    refresh().catch(e => setStatus('–û—à–∏–±–∫–∞: ' + e.message));
  </script>
</body>
</html>

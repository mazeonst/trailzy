<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TG Zenly Simple</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    .panel{
      position:absolute;z-index:999;left:12px;top:12px;
      background:#fff;padding:10px;border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);
      font-family:system-ui; max-width: 360px;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    button,input{padding:8px 10px;border-radius:10px;border:1px solid #ddd}
    button{background:#f7f7f7;cursor:pointer}
    .muted{font-size:12px;opacity:.7}
    code{background:#f1f1f1;padding:2px 6px;border-radius:6px}
    .friends{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;margin-top:6px}
    .friend{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #eee;border-radius:10px;cursor:pointer;transition:.15s background}
    .friend:hover{background:#f5f7fb}
    .friend__avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:1px solid #e4e4e4;flex-shrink:0}
    .friend__title{font-weight:600;font-size:14px}
    .friend__subtitle{font-size:12px;color:#555}
    .friend__status{margin-left:auto;font-size:12px;color:#777}
    .avatar-icon{border-radius:50%;border:2px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.25);object-fit:cover}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="row">
      <button id="btnRefresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button id="btnInvite">‚ûï –ò–Ω–≤–∞–π—Ç</button>
    </div>

    <div class="row">
      <input id="code" placeholder="–ö–æ–¥ –∏–Ω–≤–∞–π—Ç–∞" />
      <button id="btnAccept">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
    </div>

    <div class="muted" id="status">...</div>
    <div class="muted">ID –±–µ—Ä—ë—Ç—Å—è –∏–∑ Telegram WebApp –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.</div>

    <div class="muted" style="margin-top:6px">–¢–≤–æ–∏ –¥—Ä—É–∑—å—è</div>
    <div id="friends" class="friends"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    tg?.ready();

    const userId = tg?.initDataUnsafe?.user?.id;
    const username = tg?.initDataUnsafe?.user?.username;
    const name = [tg?.initDataUnsafe?.user?.first_name, tg?.initDataUnsafe?.user?.last_name]
      .filter(Boolean)
      .join(" ");
    const statusEl = document.getElementById("status");
    const friendsEl = document.getElementById("friends");

    function setStatus(t){ statusEl.textContent = t; }

    const map = L.map("map").setView([52.37, 4.90], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const markers = new Map();
    const defaultAvatar =
      "data:image/svg+xml;utf8," +
      encodeURIComponent(`<?xml version="1.0"?><svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" rx="20" fill="#1d9bf0"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-size="48" font-family="Arial" fill="white">üë§</text></svg>`);

    async function api(path, opts={}) {
      const r = await fetch("/trailzy" + path, {
        ...opts,
        headers: { "Content-Type":"application/json", ...(opts.headers||{}) }
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function renderFriends(friends){
      friendsEl.innerHTML = "";
      if (!friends.length){
        friendsEl.innerHTML = '<div class="muted">–î—Ä—É–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
        return;
      }

      friends.forEach(f => {
        const el = document.createElement("div");
        el.className = "friend";
        el.onclick = () => {
          const marker = markers.get(f.id);
          if (marker){
            map.setView(marker.getLatLng(), 14);
            marker.openPopup();
          }
        };

        const img = document.createElement("img");
        img.className = "friend__avatar";
        img.src = f.avatar_url || defaultAvatar;
        img.alt = f.name || `Friend ${f.id}`;
        el.appendChild(img);

        const textWrap = document.createElement("div");
        const title = document.createElement("div");
        title.className = "friend__title";
        title.textContent = f.name || `Friend ${f.id}`;
        const subtitle = document.createElement("div");
        subtitle.className = "friend__subtitle";
        subtitle.textContent = f.username ? `@${f.username}` : `ID: ${f.id}`;
        textWrap.appendChild(title);
        textWrap.appendChild(subtitle);
        el.appendChild(textWrap);

        const status = document.createElement("div");
        status.className = "friend__status";
        status.textContent = f.location ? "üü¢ –Ω–∞ –∫–∞—Ä—Ç–µ" : "‚ö™ –Ω–µ—Ç –ª–æ–∫–∞—Ü–∏–∏";
        el.appendChild(status);

        friendsEl.appendChild(el);
      });
    }

    function makeLabel(friend){
      const updated = friend.location ? new Date(friend.location.updated_at*1000).toLocaleString() : "‚Äî";
      return `${friend.name || "–î—Ä—É–≥"}\n@${friend.username || "–±–µ–∑ –Ω–∏–∫–∞"}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated}`;
    }

    function avatarIcon(url){
      return L.icon({
        iconUrl: url || defaultAvatar,
        iconSize: [48,48],
        className: "avatar-icon",
      });
    }

    async function refresh() {
      if (!userId) {
        setStatus("‚ùó –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram WebApp (–∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ)");
        return;
      }
      const me = await api(`/api/me?user_id=${encodeURIComponent(userId)}`);
      const friends = await api(`/api/friends-full?user_id=${encodeURIComponent(userId)}`);
      const locs = friends.friends.filter(f => !!f.location);

      // remove missing
      const ids = new Set(locs.map(x => x.id));
      for (const [id, m] of markers.entries()){
        if (!ids.has(id)) { map.removeLayer(m); markers.delete(id); }
      }

      // upsert
      locs.forEach(l => {
        let m = markers.get(l.id);
        const label = makeLabel(l);
        if (!m){
          m = L.marker([l.location.lat, l.location.lon], { icon: avatarIcon(l.avatar_url) }).addTo(map).bindPopup(label);
          markers.set(l.id, m);
        } else {
          m.setLatLng([l.location.lat, l.location.lon]).setPopupContent(label);
        }
      });

      renderFriends(friends.friends);
      const meName = me.name || name || username || `ID ${userId}`;
      setStatus(`–í—ã: ${meName} | –î—Ä—É–∑–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ: ${locs.length}`);
      if (locs.length) map.setView([locs[0].location.lat, locs[0].location.lon], 13);
    }

    document.getElementById("btnRefresh").onclick = () => refresh().catch(e => setStatus("–û—à–∏–±–∫–∞: " + e.message));

    document.getElementById("btnInvite").onclick = async () => {
      try {
        const res = await api(`/api/invite?user_id=${encodeURIComponent(userId)}`, { method:"POST", body:"{}" });
        alert("–ò–Ω–≤–∞–π—Ç –∫–æ–¥:\n" + res.code);
      } catch(e) { setStatus("–û—à–∏–±–∫–∞: " + e.message); }
    };

    document.getElementById("btnAccept").onclick = async () => {
      try {
        const code = document.getElementById("code").value.trim();
        if (!code) return;
        await api(`/api/accept?user_id=${encodeURIComponent(userId)}&code=${encodeURIComponent(code)}`, { method:"POST", body:"{}" });
        setStatus("‚úÖ –ü—Ä–∏–Ω—è—Ç–æ. –û–±–Ω–æ–≤–ª—è—é...");
        await refresh();
      } catch(e) { setStatus("–û—à–∏–±–∫–∞: " + e.message); }
    };

    refresh().catch(e => setStatus("–û—à–∏–±–∫–∞: " + e.message));
  </script>
</body>
</html>

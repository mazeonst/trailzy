<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TG Zenly Simple</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root {
      --bg: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 10px 40px rgba(0,0,0,.12);
      --accent: #2563eb;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --card: #111827;
      --border: #1f2937;
      --shadow: 0 10px 40px rgba(0,0,0,.4);
      --accent: #60a5fa;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background: var(--bg); color: var(--text); font-family: "Inter", system-ui, -apple-system, sans-serif; }
    #map { height:100%; }

    .layout {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .panel {
      position:absolute;z-index:999;left:12px;top:12px;
      background:var(--card);padding:12px;border-radius:14px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      max-width: 380px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .panel__header {
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
    }

    .title {
      font-weight:700;
      letter-spacing:-0.02em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title small { color: var(--muted); font-weight:500; }

    .pill {
      padding:6px 10px;
      background: rgba(37, 99, 235, 0.08);
      color: var(--accent);
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.12);
      font-size:12px;
    }

    .row {display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    button,input,select {padding:9px 11px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);}
    button {cursor:pointer; transition: all .15s ease;}
    button:hover { border-color: var(--accent); color: var(--accent); }
    .muted {font-size:12px;color:var(--muted);}
    code{background:rgba(15,23,42,.06);padding:2px 6px;border-radius:6px;color:var(--text);}
    .friends{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;margin-top:2px}
    .friend{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:.15s background, .15s border-color}
    .friend:hover{background:rgba(37,99,235,.05);border-color:rgba(37,99,235,.18)}
    .friend.active{border-color: var(--accent); box-shadow: 0 4px 12px rgba(37,99,235,.18);}
    .friend__avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--border);flex-shrink:0}
    .friend__title{font-weight:600;font-size:14px}
    .friend__subtitle{font-size:12px;color:var(--muted)}
    .friend__status{margin-left:auto;font-size:12px;color:var(--muted);text-align:right}
    .avatar-icon{border-radius:50%;border:2px solid var(--card);box-shadow:0 4px 12px rgba(0,0,0,.25);object-fit:cover}

    .section-title { font-weight:600; margin-top:4px; display:flex; align-items:center; gap:6px; }

    .settings { border:1px dashed var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .setting-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .setting-row .label { font-weight:600; }
    .setting-row small { color: var(--muted); display:block; }

    .toggle { position: relative; width: 44px; height: 24px; border-radius: 999px; background: var(--border); transition: background .2s; cursor: pointer; flex-shrink:0; }
    .toggle::after { content:""; position:absolute; width:20px; height:20px; top:2px; left:2px; background:#fff; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,.2); transition: transform .2s; }
    .toggle.on { background: var(--accent); }
    .toggle.on::after { transform: translateX(20px); }

    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    .controls button { flex:1; min-width:120px; }

    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .chip { padding:7px 10px; border-radius:10px; border:1px solid var(--border); cursor:pointer; font-weight:600; color: var(--muted); }
    .chip.active { border-color: var(--accent); color: var(--accent); background: rgba(37,99,235,.08); }

    .badge { padding:2px 8px; border-radius:8px; border:1px solid var(--border); font-size:11px; color: var(--muted); }

    @media (max-width: 720px) {
      .panel {
        left: 0; right: 0; bottom:0; top:auto;
        margin: 0 10px 10px 10px;
        max-width: unset;
        backdrop-filter: blur(12px);
      }
      .friends { max-height: 180px; }
      .controls button { flex: 1 0 45%; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <div id="map"></div>

    <div class="panel" id="panel">
      <div class="panel__header">
        <div class="title">TG Zenly <small>web</small></div>
        <div class="pill" id="pillState">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <div class="controls">
        <button id="btnRefresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnInvite">‚ûï –ò–Ω–≤–∞–π—Ç</button>
        <button id="btnSettings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>

      <div class="row">
        <input id="code" placeholder="–ö–æ–¥ –∏–Ω–≤–∞–π—Ç–∞" />
        <button id="btnAccept">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
      </div>

      <div class="muted" id="status">...</div>
      <div class="muted">
        –¢–≤–æ–π user_id –±–µ—Ä—ë—Ç—Å—è –∏–∑ URL: <code>?user_id=123</code>
      </div>

      <div class="settings" id="settings" hidden>
        <div class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="setting-row">
          <div>
            <div class="label">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
            <small>–û–±–Ω–æ–≤–ª—è—Ç—å —Å–ø–∏—Å–æ–∫ –∏ –∫–∞—Ä—Ç—É –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥</small>
          </div>
          <div class="row" style="gap:6px; align-items:center;">
            <input type="number" id="refreshInterval" min="5" max="120" value="20" style="width:72px" />
            <div class="toggle" id="toggleAuto"></div>
          </div>
        </div>

        <div class="setting-row">
          <div>
            <div class="label">–°–ª–µ–¥–∏—Ç—å –∑–∞ –¥—Ä—É–≥–æ–º</div>
            <small>–ê–≤—Ç–æ–ø—Ä–∏–ª–∏–ø–∞–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –¥—Ä—É–≥—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</small>
          </div>
          <div class="toggle" id="toggleFollow"></div>
        </div>

        <div class="setting-row">
          <div>
            <div class="label">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ñ–ª–∞–π–Ω</div>
            <small>–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥—Ä—É–∑–µ–π –±–µ–∑ –ª–æ–∫–∞—Ü–∏–∏ –≤ —Å–ø–∏—Å–∫–µ</small>
          </div>
          <div class="toggle" id="toggleOffline"></div>
        </div>

        <div class="setting-row" style="align-items:flex-start;">
          <div>
            <div class="label">–¢–µ–º–∞</div>
            <small>–°–∏—Å—Ç–µ–º–Ω–∞—è, —Å–≤–µ—Ç–ª–∞—è –∏–ª–∏ —Ç—ë–º–Ω–∞—è</small>
          </div>
          <div class="chips" id="themeChips"></div>
        </div>
      </div>

      <div class="section-title">üë• –¢–≤–æ–∏ –¥—Ä—É–∑—å—è <span class="badge" id="friendsBadge">0</span></div>
      <div id="friends" class="friends"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const userId = qs.get("user_id");
    const statusEl = document.getElementById("status");
    const friendsEl = document.getElementById("friends");
    const pillState = document.getElementById("pillState");
    const friendsBadge = document.getElementById("friendsBadge");
    const settingsEl = document.getElementById("settings");
    const settingsBtn = document.getElementById("btnSettings");
    const themeChips = document.getElementById("themeChips");
    const toggleAuto = document.getElementById("toggleAuto");
    const toggleFollow = document.getElementById("toggleFollow");
    const toggleOffline = document.getElementById("toggleOffline");
    const refreshIntervalInput = document.getElementById("refreshInterval");

    const STORAGE_KEY = "tgzenly_settings_v1";
    const defaultSettings = { autoRefresh: true, followFriend: true, showOffline: true, refreshInterval: 20, theme: "system" };
    let settings = { ...defaultSettings };
    let selectedFriendId = null;
    let refreshTimer = null;
    let lastFriends = [];

    const map = L.map("map").setView([52.37, 4.90], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const markers = new Map();
    const defaultAvatar =
      "data:image/svg+xml;utf8," +
      encodeURIComponent(`<?xml version="1.0"?><svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect width="120" height="120" rx="20" fill="#1d9bf0"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" font-size="48" font-family="Arial" fill="white">üë§</text></svg>`);

    async function api(path, opts={}) {
      const r = await fetch(path, {
        ...opts,
        headers: { "Content-Type":"application/json", ...(opts.headers||{}) }
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function setStatus(t){ statusEl.textContent = t; pillState.textContent = t; }

    function loadSettings(){
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) settings = { ...settings, ...JSON.parse(saved) };
      } catch(e) {}
      applySettingsUI();
      applyTheme(settings.theme);
    }

    function saveSettings(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    }

    function applyTheme(theme){
      let resolved = theme;
      if (theme === "system"){
        resolved = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      }
      document.documentElement.setAttribute("data-theme", resolved);
    }

    function applySettingsUI(){
      toggleAuto.classList.toggle("on", settings.autoRefresh);
      toggleFollow.classList.toggle("on", settings.followFriend);
      toggleOffline.classList.toggle("on", settings.showOffline);
      refreshIntervalInput.value = settings.refreshInterval;

      themeChips.innerHTML = "";
      ["system","light","dark"].forEach(mode => {
        const chip = document.createElement("div");
        chip.className = "chip" + (settings.theme === mode ? " active" : "");
        chip.textContent = mode === "system" ? "–°–∏—Å—Ç–µ–º–Ω–∞—è" : (mode === "light" ? "–°–≤–µ—Ç–ª–∞—è" : "–¢—ë–º–Ω–∞—è");
        chip.onclick = () => { settings.theme = mode; applySettingsUI(); applyTheme(mode); saveSettings(); };
        themeChips.appendChild(chip);
      });
    }

    function renderFriends(friends){
      lastFriends = friends;
      friendsEl.innerHTML = "";
      const visible = settings.showOffline ? friends : friends.filter(f => !!f.location);
      friendsBadge.textContent = visible.length;
      if (!visible.length){
        friendsEl.innerHTML = '<div class="muted">–î—Ä—É–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
        return;
      }

      visible.forEach(f => {
        const el = document.createElement("div");
        el.className = "friend" + (selectedFriendId === f.id ? " active" : "");
        el.onclick = () => {
          const marker = markers.get(f.id);
          if (marker){
            map.setView(marker.getLatLng(), 14);
            marker.openPopup();
          }
          selectedFriendId = f.id;
          renderFriends(friends);
        };

        const img = document.createElement("img");
        img.className = "friend__avatar";
        img.src = f.avatar_url || defaultAvatar;
        img.alt = f.name || `Friend ${f.id}`;
        el.appendChild(img);

        const textWrap = document.createElement("div");
        const title = document.createElement("div");
        title.className = "friend__title";
        title.textContent = f.name || `Friend ${f.id}`;
        const subtitle = document.createElement("div");
        subtitle.className = "friend__subtitle";
        subtitle.textContent = f.username ? `@${f.username}` : `ID: ${f.id}`;
        textWrap.appendChild(title);
        textWrap.appendChild(subtitle);
        el.appendChild(textWrap);

        const status = document.createElement("div");
        status.className = "friend__status";
        status.textContent = f.location ? `üü¢ ${new Date(f.location.updated_at*1000).toLocaleTimeString()}` : "‚ö™ –Ω–µ—Ç –ª–æ–∫–∞—Ü–∏–∏";
        el.appendChild(status);

        friendsEl.appendChild(el);
      });
    }

    function makeLabel(friend){
      const updated = friend.location ? new Date(friend.location.updated_at*1000).toLocaleString() : "‚Äî";
      return `${friend.name || "–î—Ä—É–≥"}\n@${friend.username || "–±–µ–∑ –Ω–∏–∫–∞"}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updated}`;
    }

    function avatarIcon(url){
      return L.icon({
        iconUrl: url || defaultAvatar,
        iconSize: [48,48],
        className: "avatar-icon",
      });
    }

    async function refresh() {
      if (!userId) {
        setStatus("‚ùó –î–æ–±–∞–≤—å –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä ?user_id=–¢–í–û–ô_ID");
        return;
      }
      const me = await api(`/api/me?user_id=${encodeURIComponent(userId)}`);
      const friends = await api(`/api/friends-full?user_id=${encodeURIComponent(userId)}`);
      const locs = friends.friends.filter(f => !!f.location);

      const ids = new Set(locs.map(x => x.id));
      for (const [id, m] of markers.entries()){
        if (!ids.has(id)) { map.removeLayer(m); markers.delete(id); }
      }

      locs.forEach(l => {
        let m = markers.get(l.id);
        const label = makeLabel(l);
        if (!m){
          m = L.marker([l.location.lat, l.location.lon], { icon: avatarIcon(l.avatar_url) }).addTo(map).bindPopup(label);
          markers.set(l.id, m);
        } else {
          m.setLatLng([l.location.lat, l.location.lon]).setPopupContent(label);
        }
      });

      renderFriends(friends.friends);
      setStatus(`–í—ã: ${me.name} | –î—Ä—É–∑–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ: ${locs.length}`);

      if (selectedFriendId && settings.followFriend){
        const chosen = locs.find(x => x.id === selectedFriendId);
        if (chosen){ map.setView([chosen.location.lat, chosen.location.lon], 13); }
      } else if (locs.length) {
        map.setView([locs[0].location.lat, locs[0].location.lon], 13);
      }

      scheduleRefresh();
    }

    function scheduleRefresh(){
      clearTimeout(refreshTimer);
      if (!settings.autoRefresh) return;
      const ms = Math.max(5, Number(settings.refreshInterval) || 20) * 1000;
      refreshTimer = setTimeout(() => refresh().catch(e => setStatus("–û—à–∏–±–∫–∞: " + e.message)), ms);
    }

    document.getElementById("btnRefresh").onclick = () => {
      clearTimeout(refreshTimer);
      refresh().catch(e => setStatus("–û—à–∏–±–∫–∞: " + e.message));
    };

    document.getElementById("btnInvite").onclick = async () => {
      try {
        const res = await api(`/api/invite?user_id=${encodeURIComponent(userId)}`, { method:"POST", body:"{}" });
        alert("–ò–Ω–≤–∞–π—Ç –∫–æ–¥:\n" + res.code);
      } catch(e) { setStatus("–û—à–∏–±–∫–∞: " + e.message); }
    };

    document.getElementById("btnAccept").onclick = async () => {
      try {
        const code = document.getElementById("code").value.trim();
        if (!code) return;
        await api(`/api/accept?user_id=${encodeURIComponent(userId)}&code=${encodeURIComponent(code)}`, { method:"POST", body:"{}" });
        setStatus("‚úÖ –ü—Ä–∏–Ω—è—Ç–æ. –û–±–Ω–æ–≤–ª—è—é...");
        await refresh();
      } catch(e) { setStatus("–û—à–∏–±–∫–∞: " + e.message); }
    };

    settingsBtn.onclick = () => {
      const isHidden = settingsEl.hasAttribute("hidden");
      if (isHidden) settingsEl.removeAttribute("hidden");
      else settingsEl.setAttribute("hidden", "hidden");
    };

    toggleAuto.onclick = () => {
      settings.autoRefresh = !settings.autoRefresh;
      applySettingsUI();
      saveSettings();
      scheduleRefresh();
    };
    toggleFollow.onclick = () => { settings.followFriend = !settings.followFriend; applySettingsUI(); saveSettings(); };
    toggleOffline.onclick = () => { settings.showOffline = !settings.showOffline; applySettingsUI(); saveSettings(); renderFriends(lastFriends || []); };
    refreshIntervalInput.onchange = (e) => {
      const v = Number(e.target.value) || 20;
      settings.refreshInterval = Math.min(Math.max(5, v), 300);
      applySettingsUI();
      saveSettings();
      scheduleRefresh();
    };

    async function init(){
      loadSettings();
      await refresh();
    }

    init().catch(e => setStatus("–û—à–∏–±–∫–∞: " + e.message));
  </script>
</body>
</html>
